<!DOCTYPE html>
<html lang="{{ app.request.locale|default('fr') }}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="icon" type="image/x-icon" href="{{ asset('favicon.ico') }}" />
    <link rel="apple-touch-icon" href="{{ asset('apple-touch-icon.png') }}" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      referrerpolicy="no-referrer"
    />

    <title>{% block title %}Welcome!{% endblock %}</title>

    <!-- Google Tag Manager -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RG9YT46TFS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

   // IMPORTANT: ne pas envoyer de page_view automatique
  gtag('config', 'G-RG9YT46TFS', {
    send_page_view: false
  });
</script>
<!-- End Google Tag Manager -->

    {# CSS global (idéalement via importmap/asset mapper). Laisse ton système actuel. #}
    {% block stylesheets %}
      {# Exemple si tu as un CSS global :
         <link rel="stylesheet" href="{{ asset('styles/app.css') }}">
      #}
    {% endblock %}

    {# Slot CSS page (évite de mettre des <style> dans le body) #}
    {% block page_styles %}{% endblock %}

    {% block javascripts %}
      {% block importmap %}{{ importmap('app') }}{% endblock %}
      <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

    {% endblock %}
  </head>

  <body data-controller="layout">

    {# ===== Layout wrapper ===== #}
    <div class="app-shell">
      {% if app.user %}
        {# Header commun à tous les utilisateurs connectés #}
        {% include './components/header.html.twig' %}

        {# Sidebar conditionnelle selon le rôle #}
        {% if is_granted('ROLE_ADMIN') %}
          {% include './components/sidebar_admin.html.twig' %}
        {% elseif is_granted('ROLE_USER') %}
          {% include './components/sidebar.html.twig' %}
        {% endif %}

        {# Backdrop sidebar (uniquement si une sidebar est affichée) #}
        {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_USER') %}
          <div
            class="sidebar-backdrop"
            data-layout-target="backdrop"
            data-action="click->layout#closeSidebar"
            aria-hidden="true"
          ></div>
        {% endif %}
      {% endif %}

      <div class="wrapper-layout">
        <main class="main-content" id="main-content" tabindex="-1">
          {# ===== Flash messages ===== #}
          {% if app.flashes is not empty %}
            <div class="flash-messages-container">
              {% for type, messages in app.flashes %}
                {% for message in messages %}
                  <div class="alert alert-{{ type }}" role="alert">
                    {{ message }}
                  </div>
                {% endfor %}
              {% endfor %}
            </div>
          {% endif %}

          {# ===== Breadcrumb (optionnel) ===== #}
          {% block breadcrumb %}
            {% set currentRoute = app.request.attributes.get('_route') %}
            {% set breadcrumbItems = breadcrumb_map()[currentRoute] ?? [] %}
            {% if breadcrumbItems is not empty %}
              {% include './components/parts/_breadcrumb.html.twig' with { items: breadcrumbItems } %}
            {% endif %}
          {% endblock %}

          {# ===== Contenu page ===== #}
          {% block body %}{% endblock %}
        </main>
      </div>
    </div>

    {# ===== Toasts / Alerts (fixed bottom-right) ===== #}
    {% include './components/parts/_toasts.html.twig' %}

    {# JS page #}
    {% block page_scripts %}{% endblock %}
  </body>
</html>
